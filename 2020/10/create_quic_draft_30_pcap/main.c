#include <openssl/evp.h>
#include <openssl/kdf.h>
#include <pcap/pcap.h>
#include <stdio.h>
#include <string.h>
#include <sys/time.h>

int
main()
{
	const uint8_t key[] = {
		0x17, 0x52, 0x57, 0xa3, 0x1e, 0xb0, 0x9d, 0xea,
		0x93, 0x66, 0xd8, 0xbb, 0x79, 0xad, 0x80, 0xba,
	};

	const uint8_t iv[] = {
		0x6b, 0x26, 0x11, 0x4b, 0x9c, 0xba, 0x2b, 0x63,
		0xa9, 0xe8, 0xdd, 0x4f,
	};

	const uint8_t hp[] = {
		0x9d, 0xdd, 0x12, 0xc9, 0x94, 0xc0, 0x69, 0x8b,
		0x89, 0x37, 0x4a, 0x9c, 0x07, 0x7a, 0x30, 0x77,
	};

#define PACKET_NUMBER_BYTES 1
	// unprotected header
	const uint8_t aad[] = {
#if PACKET_NUMBER_BYTES == 1
		0xc0, 0xff, 0x00, 0x00, 0x1e, 0x08, 0x83, 0x94,
		0xc8, 0xf0, 0x3e, 0x51, 0x57, 0x08, 0x00, 0x00,
		0x44, 0x9b, 0x01,
#elif PACKET_NUMBER_BYTES == 2
		0xc1, 0xff, 0x00, 0x00, 0x1e, 0x08, 0x83, 0x94,
		0xc8, 0xf0, 0x3e, 0x51, 0x57, 0x08, 0x00, 0x00,
		0x44, 0x9c, 0x00, 0x01,
#elif PACKET_NUMBER_BYTES == 3
		0xc2, 0xff, 0x00, 0x00, 0x1e, 0x08, 0x83, 0x94,
		0xc8, 0xf0, 0x3e, 0x51, 0x57, 0x08, 0x00, 0x00,
		0x44, 0x9d, 0x00, 0x00, 0x01,
#elif PACKET_NUMBER_BYTES == 4
		0xc3, 0xff, 0x00, 0x00, 0x1e, 0x08, 0x83, 0x94,
		0xc8, 0xf0, 0x3e, 0x51, 0x57, 0x08, 0x00, 0x00,
		0x44, 0x9e, 0x00, 0x00, 0x00, 0x02,
#else
#error "Invalid packet number bytes, and it can only be 1 ~ 4"
#endif
	};

	// the packet number is 0x0001;
	uint8_t nonce[sizeof(iv)];
	{
		size_t packet_number_offset = sizeof(aad) - PACKET_NUMBER_BYTES;
		size_t nonce_offset = sizeof(iv) - PACKET_NUMBER_BYTES;
		memcpy(nonce, iv, nonce_offset);
		for (size_t i = 0; i < PACKET_NUMBER_BYTES; i++) {
			nonce[nonce_offset] = iv[nonce_offset] ^ aad[packet_number_offset];
			nonce_offset++;
			packet_number_offset++;
		}
	}
	
	const uint8_t pt[] = {
		0x06, 0x00, 0x40, 0xf1, 0x01, 0x00, 0x00, 0xed,
		0x03, 0x03, 0xeb, 0xf8, 0xfa, 0x56, 0xf1, 0x29,
		0x39, 0xb9, 0x58, 0x4a, 0x38, 0x96, 0x47, 0x2e,
		0xc4, 0x0b, 0xb8, 0x63, 0xcf, 0xd3, 0xe8, 0x68,
		0x04, 0xfe, 0x3a, 0x47, 0xf0, 0x6a, 0x2b, 0x69,
		0x48, 0x4c, 0x00, 0x00, 0x04, 0x13, 0x01, 0x13,
		0x02, 0x01, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00,
		0x10, 0x00, 0x0e, 0x00, 0x00, 0x0b, 0x65, 0x78,
		0x61, 0x6d, 0x70, 0x6c, 0x65, 0x2e, 0x63, 0x6f,
		0x6d, 0xff, 0x01, 0x00, 0x01, 0x00, 0x00, 0x0a,
		0x00, 0x08, 0x00, 0x06, 0x00, 0x1d, 0x00, 0x17,
		0x00, 0x18, 0x00, 0x10, 0x00, 0x07, 0x00, 0x05,
		0x04, 0x61, 0x6c, 0x70, 0x6e, 0x00, 0x05, 0x00,
		0x05, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33,
		0x00, 0x26, 0x00, 0x24, 0x00, 0x1d, 0x00, 0x20,
		0x93, 0x70, 0xb2, 0xc9, 0xca, 0xa4, 0x7f, 0xba,
		0xba, 0xf4, 0x55, 0x9f, 0xed, 0xba, 0x75, 0x3d,
		0xe1, 0x71, 0xfa, 0x71, 0xf5, 0x0f, 0x1c, 0xe1,
		0x5d, 0x43, 0xe9, 0x94, 0xec, 0x74, 0xd7, 0x48,
		0x00, 0x2b, 0x00, 0x03, 0x02, 0x03, 0x04, 0x00,
		0x0d, 0x00, 0x10, 0x00, 0x0e, 0x04, 0x03, 0x05,
		0x03, 0x06, 0x03, 0x02, 0x03, 0x08, 0x04, 0x08,
		0x05, 0x08, 0x06, 0x00, 0x2d, 0x00, 0x02, 0x01,
		0x01, 0x00, 0x1c, 0x00, 0x02, 0x40, 0x01, 0xff,
		0xa5, 0x00, 0x32, 0x04, 0x08, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0x05, 0x04, 0x80,
		0x00, 0xff, 0xff, 0x07, 0x04, 0x80, 0x00, 0xff,
		0xff, 0x08, 0x01, 0x10, 0x01, 0x04, 0x80, 0x00,
		0x75, 0x30, 0x09, 0x01, 0x10, 0x0f, 0x08, 0x83,
		0x94, 0xc8, 0xf0, 0x3e, 0x51, 0x57, 0x08, 0x06,
		0x04, 0x80, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00,
	};

	uint8_t quic_packet[1500];
	memcpy(quic_packet, aad, sizeof(aad));
	int quic_packet_len = sizeof(aad);
	
	uint8_t *ct = &quic_packet[sizeof(aad)];
	int len, ct_len;

	EVP_CIPHER_CTX *ctx = EVP_CIPHER_CTX_new();

	if (EVP_EncryptInit_ex(ctx, EVP_aes_128_gcm(), NULL, key, nonce) == 0) {
		return 1;
	}

	if (EVP_EncryptUpdate(ctx, NULL, &len, aad, sizeof(aad)) == 0) {
		return 1;
	}

	if (EVP_EncryptUpdate(ctx, ct, &ct_len, pt, sizeof(pt)) == 0) {
		return 1;
	}

	if (EVP_EncryptFinal_ex(ctx, ct + ct_len, &len) == 0) {
		return 1;
	}

	if (EVP_CIPHER_CTX_ctrl(ctx, EVP_CTRL_GCM_GET_TAG, 16, ct + ct_len) == 0) {
		return 1;
	}

	EVP_CIPHER_CTX_free(ctx);

	quic_packet_len += (ct_len + 16);

	uint8_t mask[sizeof(hp)];
	ctx = EVP_CIPHER_CTX_new();

	if (EVP_EncryptInit_ex(ctx, EVP_aes_128_ecb(), NULL, hp, NULL) == 0) {
		return 1;
	}

	if (EVP_EncryptUpdate(ctx, mask, &ct_len, ct + (4 - PACKET_NUMBER_BYTES), sizeof(hp)) == 0) {
		return 1;
	}

	if (EVP_EncryptFinal_ex(ctx, mask + ct_len, &len) == 0) {
		return 1;
	}

	EVP_CIPHER_CTX_free(ctx);

	quic_packet[0] ^= (mask[0] & 0x0f);
	{
		size_t packet_number_offset = sizeof(aad) - PACKET_NUMBER_BYTES;
		for (size_t i = 0; i < PACKET_NUMBER_BYTES; i++) {
			quic_packet[packet_number_offset] ^= mask[1 + i];
			packet_number_offset++;
		}
	}

	// This header includes Ethernet + IP + UDP
	char header[] = {
		0x36, 0xe1, 0x2d, 0xb4, 0x3f, 0x9d, 0x76, 0x48,
		0x8a, 0x8c, 0x6e, 0xf6, 0x08, 0x00, 0x45, 0x00,
		0x04, 0xec, 0x00, 0x00, 0x40, 0x00, 0x40, 0x11,
		0xdf, 0x77, 0xc0, 0xa8, 0x00, 0x01, 0xc0, 0xa8,
		0x00, 0x02, 0xc0, 0x05, 0x01, 0xbb, 0x04, 0xd8,
		0x49, 0xee,
	};

	uint16_t ethernet_header_len = 14;
	uint16_t ip_header_len = 20;
	uint16_t udp_header_len = 8;

	// Modify "Total Length" field in IP header
	uint16_t ip_packet_len = ip_header_len + udp_header_len + quic_packet_len;
	header[ethernet_header_len + 2] = (ip_packet_len & 0xff00) >> 8;
	header[ethernet_header_len + 3] = (uint8_t)ip_packet_len;

	// Modify "Length" field in UDP header
	uint16_t udp_packet_len = udp_header_len + quic_packet_len;
	header[ethernet_header_len + ip_header_len + 4] = (udp_packet_len & 0xff00) >> 8;
	header[ethernet_header_len + ip_header_len + 5] = (uint8_t)udp_packet_len;

	pcap_t *pcap_handle = pcap_open_dead(DLT_EN10MB, 262144);
	pcap_dumper_t *pcap_dumper = pcap_dump_open(pcap_handle, "quic-ietf-draft-30.pcap");
	if (pcap_dumper == NULL) {
		printf("pcap_dump_open error: %s\n", pcap_geterr(pcap_handle));
		pcap_close(pcap_handle);
		return 1;
	}
	pcap_close(pcap_handle);

	struct pcap_pkthdr pcap_header;
	gettimeofday(&pcap_header.ts, NULL);
	pcap_header.len = sizeof(header) + quic_packet_len;
	pcap_header.caplen = sizeof(header) + quic_packet_len;

	uint8_t pcap_data[sizeof(header) + quic_packet_len];
	memcpy(pcap_data, header, sizeof(header));
	memcpy(&pcap_data[sizeof(header)], quic_packet, quic_packet_len);

	pcap_dump((u_char *)pcap_dumper, &pcap_header, pcap_data);
	pcap_dump_close(pcap_dumper);

	return 0;
}
